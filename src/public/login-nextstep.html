<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>One more step.. - openplace</title>
	<link rel="stylesheet" href="/account.css">
</head>
<body>
	<div class="login-form">
		<h1>One more step..</h1>
		<p id="status">Loading...</p>
		<div id="error" class="error"></div>
		<div id="content" style="display: none;">
			<p>Link your Discord account to openplace!</p>
			<p>When you link your Discord account to openplace, you will receive exclusive perks such as shortened cooldown times, account recovery, and much more.</p>
			<button id="linkButton">Link Discord Account</button>
			<br><br>
			<button class="secondary-button skipButton">Not now</button>
		</div>
		<div id="success" style="display: none;">
			<p>Discord account linked successfully!</p>
			<button class="secondary-button skipButton">Not now</button>
		</div>
	</div>

	<script>
	(async () => {
		const statusDiv = document.getElementById("status");
		const errorDiv = document.getElementById("error");
		const contentDiv = document.getElementById("content");
		const successDiv = document.getElementById("success");
		const linkButton = document.getElementById("linkButton");

		try {
			const meRes = await fetch("/me", {
				credentials: "include"
			});

			if (!meRes.ok) {
				statusDiv.textContent = "You must be logged in to link your Discord account.";
				return;
			}

			const userData = await meRes.json();
			if (userData.discordUserId) {
				statusDiv.style.display = "none";
				successDiv.style.display = "block";
				successDiv.innerHTML = `
					<p>Your Discord account is already linked!</p>
					<p><strong>Discord Username:</strong> ${userData.discord || "Unknown"}</p>
					<a href="/discord/unlink">Unlink Discord Account</a>
					<br><br>
					<button id="skipButton" class="secondary-button">Back to home</button>
				`;
				return;
			}

			const configRes = await fetch("/discord/configured");
			if (!configRes.ok) {
				statusDiv.textContent = "";
				errorDiv.textContent = "Discord OAuth is not configured on this server.";
				return;
			}

			statusDiv.style.display = "none";
			contentDiv.style.display = "block";

			linkButton.addEventListener("click", async () => {
				try {
					linkButton.disabled = true;
					linkButton.textContent = "Redirecting...";

					const res = await fetch("/discord/auth-url", {
						credentials: "include"
					});

					if (!res.ok) {
						throw new Error("Failed to get Discord authorization URL");
					}

					const data = await res.json();
					window.location.href = data.url;
				} catch (error) {
					errorDiv.textContent = error.message;
					linkButton.disabled = false;
					linkButton.textContent = "Link Discord Account";
				}
			});
				// idk why the skip button is throwing a fit with the event listener sooooo this is gonna have to do ig - toby
				function attachSkipListeners() {
					document.querySelectorAll('.skipButton').forEach(btn => {
						btn.onclick = async (event) => {
							try {
								btn.disabled = true;
								btn.textContent = 'Redirecting...';
								window.location.href = '/';
							} catch (error) {
								errorDiv.textContent = error.message;
								btn.disabled = false;
								btn.textContent = 'Not now';
							}
						};
					});
				}

				attachSkipListeners();
		} catch (error) {
			statusDiv.textContent = "An error occurred.";
			errorDiv.textContent = error.message;
		}
	})();
	</script>
</body>
</html>
